name: Mozilla Upload - Debug (Dry Run)

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      release_tag:
        description: 'Release tag to reference (e.g., v1.0.3-20251114-192449)'
        required: true
        type: string

jobs:
  debug-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_tag }}

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== Downloading extension zip ==="
          gh release download ${{ inputs.release_tag }} \
            -p "makeitpop-extension.zip" \
            -R ${{ github.repository }}

          echo "=== Extension zip downloaded ==="
          ls -lh makeitpop-extension.zip
          unzip -l makeitpop-extension.zip

          echo ""
          echo "=== Downloading source archive ==="
          gh release download ${{ inputs.release_tag }} \
            -A zip \
            -R ${{ github.repository }}

          # Rename the source archive to match expected name
          mv make-it-pop-*.zip makeitpop-source.zip || \
          mv ${{ github.event.repository.name }}-*.zip makeitpop-source.zip

          echo "=== Source archive downloaded ==="
          ls -lh makeitpop-source.zip
          unzip -l makeitpop-source.zip | head -50

      - name: Get release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ inputs.release_tag }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG}"

          echo "=== Release Information ==="
          echo "Tag: ${RELEASE_TAG}"
          echo "URL: ${RELEASE_URL}"

          # Get release notes/changelog from the GitHub release
          RELEASE_NOTES=$(gh release view ${{ inputs.release_tag }} \
            --json body \
            --jq '.body' \
            -R ${{ github.repository }})

          echo "url=${RELEASE_URL}" >> $GITHUB_OUTPUT
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

          # Save release notes to a file for later use (multiline handling)
          echo "$RELEASE_NOTES" > release_notes.txt

          echo ""
          echo "=== Release Notes/Changelog ==="
          cat release_notes.txt

      - name: Prepare AMO metadata
        run: |
          echo "=== Preparing AMO Metadata ==="

          # Create metadata JSON with release notes
          cat > amo-metadata.json <<'JSON_END'
          {
            "version": {
              "approval_notes": "Hello, this is the new build and links to the related commit HEAD:\n${{ steps.release.outputs.url }}",
              "release_notes": {
                "en-US": $(jq -Rs . < release_notes.txt)
              },
              "license": "MIT",
              "source": "makeitpop-source.zip"
            }
          }
          JSON_END

          echo ""
          echo "=== AMO Metadata JSON ==="
          cat amo-metadata.json

          echo ""
          echo "=== Validating JSON ==="
          if jq empty amo-metadata.json 2>/dev/null; then
            echo "✓ JSON is valid"
          else
            echo "✗ JSON is invalid!"
            exit 1
          fi

      - name: Show what would be uploaded
        run: |
          echo ""
          echo "======================================"
          echo "=== DRY RUN - NO UPLOAD WILL OCCUR ==="
          echo "======================================"
          echo ""
          echo "The following would be sent to Mozilla Add-ons:"
          echo ""
          echo "Extension GUID: ${{ vars.MOZILLA_EXTENSIONS_ID }}"
          echo "Channel: listed"
          echo "Extension file: makeitpop-extension.zip ($(stat -f%z makeitpop-extension.zip 2>/dev/null || stat -c%s makeitpop-extension.zip) bytes)"
          echo "Source file: makeitpop-source.zip ($(stat -f%z makeitpop-source.zip 2>/dev/null || stat -c%s makeitpop-source.zip) bytes)"
          echo ""
          echo "--- Approval Notes ---"
          echo "Hello, this is the new build and links to the related commit HEAD:"
          echo "${{ steps.release.outputs.url }}"
          echo ""
          echo "--- Release Notes (en-US) ---"
          cat release_notes.txt
          echo ""
          echo "--- Full Metadata ---"
          jq . amo-metadata.json
          echo ""
          echo "======================================"
          echo "=== END DRY RUN ==="
          echo "======================================"
