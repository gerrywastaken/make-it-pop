name: Upload to Mozilla Add-ons

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      release_tag:
        description: 'Release URL or tag (e.g., https://github.com/gerrywastaken/make-it-pop/releases/tag/v1.0.3-20251120-224046 OR v1.0.3-20251120-224046)'
        required: true
        type: string

jobs:
  upload-to-mozilla:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Extract release tag from URL or input
        id: extract_tag
        run: |
          INPUT="${{ inputs.release_tag }}"
          # If input contains '/releases/tag/', extract the tag portion
          if [[ "$INPUT" == *"/releases/tag/"* ]]; then
            RELEASE_TAG="${INPUT##*/}"
            echo "Extracted tag from URL: $RELEASE_TAG"
          else
            RELEASE_TAG="$INPUT"
            echo "Using tag as provided: $RELEASE_TAG"
          fi
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.extract_tag.outputs.tag }}

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Download the extension zip
          gh release download ${{ steps.extract_tag.outputs.tag }} \
            -p "makeitpop-extension.zip" \
            -R ${{ github.repository }}

          # Download the source archive (GitHub auto-generates this)
          gh release download ${{ steps.extract_tag.outputs.tag }} \
            -A zip \
            -R ${{ github.repository }}

          # Rename the source archive to match expected name
          mv make-it-pop-*.zip makeitpop-source.zip || \
          mv ${{ github.event.repository.name }}-*.zip makeitpop-source.zip

      - name: Get release info
        id: release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="${{ steps.extract_tag.outputs.tag }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${RELEASE_TAG}"

          # Get release notes/changelog from the GitHub release
          RELEASE_NOTES=$(gh release view ${{ steps.extract_tag.outputs.tag }} \
            --json body \
            --jq '.body' \
            -R ${{ github.repository }})

          echo "url=${RELEASE_URL}" >> $GITHUB_OUTPUT
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

          # Save release notes to a file for later use (multiline handling)
          echo "$RELEASE_NOTES" > release_notes.txt

      - name: Prepare AMO metadata
        run: |
          # Create metadata JSON with release notes using jq
          RELEASE_NOTES_JSON=$(jq -Rs . < release_notes.txt)

          jq -n \
            --arg approval_notes "Hello, this is the new build and links to the related commit HEAD:\n${{ steps.release.outputs.url }}" \
            --argjson release_notes "$RELEASE_NOTES_JSON" \
            '{
              "version": {
                "approval_notes": $approval_notes,
                "release_notes": {
                  "en-US": $release_notes
                },
                "license": "MIT",
                "source": "makeitpop-source.zip"
              }
            }' > amo-metadata.json

          echo "AMO Metadata prepared:"
          cat amo-metadata.json

      - name: Upload to Mozilla Add-ons
        uses: kewisch/action-web-ext@v1
        with:
          cmd: sign
          source: makeitpop-extension.zip
          channel: listed
          apiKey: ${{ secrets.MOZILLA_JWT_ISSUER }}
          apiSecret: ${{ secrets.MOZILLA_JWT_SECRET }}
          addon-guid: ${{ vars.MOZILLA_EXTENSIONS_ID }}
          amoMetadata: amo-metadata.json
